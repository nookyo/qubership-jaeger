name: List Docker Packages

on:
  workflow_dispatch:

jobs:
  list-packages:
    runs-on: ubuntu-latest
    permissions:
      packages: read

    steps:
      - name: List GHCR packages for this repo
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
        run: |
          api_url="https://api.github.com/users/${OWNER}/packages?package_type=container"

          response=$(curl -sS \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "$api_url")

          echo "$response" | jq -r --arg owner "$OWNER" --arg repo "$REPO" '
            if type == "array" then
              .[]
              # оставляем только пакеты, связанные с этим репозиторием
              | select(.repository.full_name == ($owner + "/" + $repo))
              | "ghcr.io/" + $owner + "/" + .name
            else
              empty
            end
          '
